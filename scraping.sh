#!/bin/sh

DATE=$(date +%Y%m%d)
USER_AGENT="Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/37.0.2062.120 Safari/537.36"

FLIGHT_NUMBER_ARRAY()
{
	LIST=(
	"12 41" # TOKYO ITAMI
	"50 84" # TOKYO CTS
	"91 92" # ISHIGAKI TOKYO
	"118 119" # ISHIGAKI NAGOYA
	"120 139" # TOKYO OKINAWA
	"141 150" # TOKYO KIX
	"161 169" # ITAMI NAGASAKI
	"191 200" # TOKYO OITA
	"239 274" # TOKYO FUKUOKA
	"280 287" # TOKYO TOKUSHIMA
	"289 290" # FUKUOKA CTS
	"292 299" # TOKYO TOTTORI
	"300 308" # NAGOYA OKINAWA
	"313 320" # FUKUOKA KOMATSU
	"321 324" # FUKUOKA NIIGATA
	"325 326" # NAGOYA ASAHIKAWA
	"327 328" # NAGOYA MEMANBETSU
	"331 336" # NAGOYA KUMAMOTO
	"337 340" # NARITA NAGOYA
	"341 348" # NAGOYA MIYAZAKI
	"351 360" # NAGOYA KAGOSHIMA
	"361 370" # NAGOYA KAGOSHIMA
	"371 374" # NAGOYA NAGASAKI
	"375 376" # TOKYO MOMBETSU
	"377 378" # TOKYO NEMURONAKASHIBETU
	"381 390" # TOKYO YONAGO
	"401 410" # TOKYO->AKITA
	"412 415" # TOKYO KOBE
	"421 430" # ITAMI FUKUOKA
	"432 450" # NAGOYA FUKUOKA
	"451 456" # TOKYO SAGA
	"480 496" # FUKUOKA OKINAWA
	"497 498" # NAGOYA HAKODATE
	"501 512" # ITAMI MIYAZAKI
	"513 520" # ITAMI NIIGATA
	"521 529" # OSAKA KUMAMOTO
	"531 540" # TOKYO TAKAMATSU
	"541 552" # ITAMI KAGOSHIMA
	"553 558" # TOKYO HAKODATE
	"561 569" # TOKYO KOCHI
	"571 572" # TOKYO WAKKANAI
	"575 576" # TOKYO HAGI-ISHIMI
	"577 578" # KOBE CTS
	"582 599" # TOKYO MATSUYAMA
	"601 618" # TOKYO MIYAZAKI
	"619 630" # TOKYO KAGOSHIMA
	"631 638" # TOKYO IWAKUNI
	"641 650" # TOKYO KUMAMOTO
	"651 660" # TOKYO OKAYAMA
	"661 670" # TOKYO NAGASAKI
	"671 688" # TOKYO HIROSHIMA
	"691 700" # TOKYO YAMAGUCHI-UBE
	"701 717" # NAGOYA CTS
	"721 730" # CTS SENDAI
	"731 740" # ITAMI SENDAI
	"747 750" # TOKYO->NOTO
	"751 760" # TOKYO->KOMATSU
	"761 768" # ITAMI OKINAWA
	"771 780" # ITAMI CTS
	"781 782" # CTS SHIZUOKA
	"783 784" # OKINAWA SHIZUOKA
	"787 790" # TOKYO->NOSHIRO
	"791 792" # CTS HIROSHIMA
	"795 798" # SENDAI FUKUOKA
	"881 892" # TOKYO->TOYAMA
	"893 900" # TOKYO->SHONAI
	"981 989" # TOKYO SAGA,OSAKA
	"995 996" # TOKYO OKINAWA (2)

	"1085 1086" # TOKYO KOCHI (2)
	"1087 1088" # TOKYO YONAGO
	"1089 1090" # TOKYO TOKUSHIMA
	"1091 1092" # TOKYO KOMATSU
	"1101 1102" # TOKYO TOTTORI (2)
	"1103 1104" # TOKYO HAGI-ISHIMI (2)
	"1187 1188" # TOKYO YONAGO (2)
	"1600 1619" # ITAMI KOCHI
	"1621 1622" # OKINAWA TAKAMATSU
	"1625 1627" # OSAKA KUMAMOTO
	"1631 1650" # OSAKA MATSUYAMA
	"1651 1656" # ITAMI AKITA
	"1666 1669" # SENDAI ITAMI
	"1671 1672" # ITAMI FUKUOKA
	"1680 1683" # ITAMI FUKUOKA
	"1687 1692" # OSAKA OITA
	"1693 1694" # CTS OKINAWA
	"1695 1697" # OSAKA FUKUSHIMA
	"1702 1709" # KIX FUKUOKA
	"1710 1720" # KIX CTS
	"1721 1730" # OKINAWA MIYAKO
	"1731 1740" # OKINAWA KIX
	"1761 1782" # OKINAWA ISHIGAKI
	"1787 1790" # KIX HAKODATE
	"1791 1792" # ISHIGAKI MIYAKO
	"1810 1813" # NAGOYA NIIGATA
	"1831 1834" # CTS AKITA
	"1837 1840" # NAGOYA AKITA
	"1843 1844" # TOKYO OSHIMA
	"1851 1856" # ITAMI AOMORI
	"1857 1858" # NIIGATA CTS
	"1861 1862" # OKINAWA HIROSHIMA
	"1863 1864" # OKINAWA SENDAI
	"1865 1866" # OKINAWA NIIGATA
	"1867 1868" # OKINAWA KUMAMOTO
	"1869 1870" # FUKUOKA ISHIGAKI
	"1871 1872" # OKINAWA NAGASAKI
	"1875 1878" # OKINAWA KAGOSHIMA
	"1883 1884" # OKINAWA NATSUYAMA
	"1891 1896" # TOKYO HACHIJOJIMA
	"1897 1900" # TOKYO HACHIJOJIMA

	"2141 2146" # NARITA FUKUOKA
	"2152 2155" # NARITA CTS
	"2158 2159" # NARITA OKINAWA
	"2176 2179" # NARITA ITAMI

	"3111 3114" # NARITA HIROSHIMA
	"3118 3119" # NARITA KOMATSU
	"3121 3126" # FUKUOKA MIYAZAKI
	"3131 3134" # ITAMI CTS
	"3137 3140" # SENDAI HIROSHIMA
	"3141 3142" # OSAKA OITA
	"3143 3148" # NAGOYA SENDAI
	"3152 3153" # ITAMI SENDAIITAMI SENDAI
	"3154 3119" # NARITA KOMATSU
	"3155 3158" # ITAMI FUKUOKA
	"3159 3160" # CTS SENDAI
	"3161 3164" # SENDAI KOMATSU
	"3165 3170" # NAGOYA OITA
	"3175 3180" # ITAMI FUKUSHIMA
	"3182 3187" # FUKUOKA SENDAI
	"3189 3190" # FUKUOKA KOMATSU
	"3231 3235" # NARITA SENDAI 
	"3239 3240" # NARITA NIIGATA
	"3711 3722" # TOKYO KUMAMOTO (2)
	"3723 3729" # KOBE OKINAWA
	"3731 3742" # TOKYO NAGASAKI (2)
	"3751 3764" # TOKYO MIYAZAKI (2)
	"3767 3768" # OKINAWA MIYAZAKI
	"3771 3782" # TOKYO KAGOSHIMA (2)
	"3783 3786" # OKINAWA KAGOSHIMA
	"3788 3795" # TOKYO OITA (2)
	"3831 3838" # NAGOYA FUKUOKA
	"3840 3859" # TOKYO FUKUOKA
	"3872 3893" # TOKYO KITA-KYUSHU
	"4641 4648" # IKI NAGASAKI
	"4651 4662" # NAGASAKI TSUSHIMA
	"4671 4676" # NAGASAKI GOTOFUKUE
	"4694 4697" # GOTOFUKUE FUKUOKA
	"4711 4739"
	"4743 4746" # TOKYO->HAKODATE
	"4761 4768" # TOKYO OBIHIRO
	"4771 4774" # TOKYO KUSHIRO
	"4775 4780" # TOKYO MEMANBETSU
	"4781 4788" # TOKYO KUSHIRO
	"4800 4811" # CTS SENDAI
	"4812 4815" # CTS FUKUSHIMA
	"4816 4819" # CTS NIIGATA
	"4820 4821" # CTS TOYAMA
	"4824 4825" # CTS KOMATSU
	"4826 4831" # KOBE CTS
	"4832 4833" # CTS OKAYAMA
	"4841 4844" # CTS WAKKANAI
	"4853 4858" # CTS HAKODATE
	"4861 4868" # CTS MEMANBETSU
	"4871 4876" # HANEDA KUSHIRO
	"4881 4886" # CTS NEMURONAKASHIBETU
	"4915 4920" # FUKUOKA GOTOFUKUE
	"4931 4940" # FUKUOKA TSUSHIMA
	"4951 4960" # FUKUOKA MIYAZAKI
	)

}

LOOP()
{
	FLIGHT_NUMBER_ARRAY
	for ((l = 0; l < ${#LIST[@]}; l++))
	do
		WGET "${LIST[$l]}"
	done
}

WGET()
{
	echo WGET hikisuu $1 
	for i in `seq $1` ; do 
		FLIGHT_NUMBER=$i
		URL="http://fs.ana.co.jp/fs/api/FlightStatus?jsoncallback=FlightStatus&airline=NH&site=DOM&lang=JA&channel=PC&sn.requestDate=${DATE}&sn.flightNumber=${FLIGHT_NUMBER}&sn.isArrived=D&ai.departure=&ai.arrival=&ri.disp=REST"
		TMPFILE=/tmp/$i

		SLEEP
		wget -q -O $TMPFILE --user-agent="${USER_AGENT}" $URL
		grep -q '"status" : "ERROR",' $TMPFILE ; RET=$?

		if [ $RET = 1 ] ; then

			DEPAIRP=$(grep depAirportCode $TMPFILE | awk -F\" '{print $4}' | head -n 1 )
			ARRAIRP=$(grep arrAirportCode $TMPFILE | awk -F\" '{print $4}' | head -n 1 )
			DEPTIME=$(grep skdDepTime $TMPFILE     | awk -F\" '{print $4}' | head -n 1 )
			ARRTIME=$(grep skdArrTime $TMPFILE     | awk -F\" '{print $4}' | head -n 1 )

			echo $i,$DEPTIME,$ARRTIME >> ./timetable/$DEPAIRP.$ARRAIRP.csv
		fi
	done
}

SEIKEI()
{
	sed -i 's/://g' timetable/*.csv
	sed -i 's/,0/,/g' timetable/*.csv
}

SLEEP()
{
	sleep $[ ( $RANDOM % 10 ) + 3 ]s
}

LOOP
SEIKEI
